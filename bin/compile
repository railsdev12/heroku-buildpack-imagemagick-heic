#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2

INSTALL_DIR="$BUILD_DIR/vendor"
mkdir -p "$INSTALL_DIR"

export PATH="$INSTALL_DIR/bin:$PATH"
export LD_LIBRARY_PATH="$INSTALL_DIR/lib:$LD_LIBRARY_PATH"
export PKG_CONFIG_PATH="$INSTALL_DIR/lib/pkgconfig:$PKG_CONFIG_PATH"

# Install build tools
echo "[INFO] Installing build tools..."
apt-get update -qq && apt-get install -y autoconf automake libtool pkg-config cmake ninja-build > /dev/null

# Create temp dir
TMP_DIR=$(mktemp -d)
echo "[INFO] Using temp dir: $TMP_DIR"
cd "$TMP_DIR"

# Build and install x265
echo "[INFO] Building x265..."
curl -sL https://bitbucket.org/multicoreware/x265_git/get/master.tar.gz -o x265.tar.gz
mkdir x265 && tar -xzf x265.tar.gz -C x265 --strip-components=1
cd x265/build/linux
cmake -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR" -DENABLE_SHARED=off ../../source
make -j4 && make install
cd "$TMP_DIR"

# Build and install libde265
echo "[INFO] Building libde265..."
curl -sL https://github.com/strukturag/libde265/archive/refs/tags/v1.0.8.tar.gz -o libde265.tar.gz
mkdir libde265 && tar -xzf libde265.tar.gz -C libde265 --strip-components=1
cd libde265
./autogen.sh
./configure --prefix="$INSTALL_DIR" --disable-shared --enable-static
make -j4 && make install
cd "$TMP_DIR"

# Build and install libheif (via CMake)
echo "[INFO] Building libheif..."
curl -sL https://github.com/strukturag/libheif/releases/download/v1.17.6/libheif-1.17.6.tar.gz -o libheif.tar.gz
mkdir libheif && tar -xzf libheif.tar.gz -C libheif --strip-components=1
cd libheif
mkdir build && cd build

echo "[INFO] Running cmake for libheif..."
cmake -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR" \
      -DCMAKE_BUILD_TYPE=Release \
      -DBUILD_SHARED_LIBS=OFF \
      -DWITH_GDK_PIXBUF=OFF \
      .. 2>&1 | tee "$BUILD_DIR/cmake-libheif.log"

echo "[INFO] Running make for libheif..."
make -j4 2>&1 | tee "$BUILD_DIR/make-libheif.log"

echo "[INFO] Installing libheif..."
make install
cd "$TMP_DIR"

# Confirm libheif.pc exists
echo "[INFO] Checking for libheif.pc..."
if [ ! -f "$INSTALL_DIR/lib/pkgconfig/libheif.pc" ]; then
  echo "[ERROR] libheif.pc not found. HEIC support may not be detected."
  exit 1
else
  echo "[INFO] libheif.pc found."
fi

# Build and install ImageMagick
echo "[INFO] Building ImageMagick with HEIC support..."
curl -sL https://imagemagick.org/archive/ImageMagick.tar.gz -o ImageMagick.tar.gz
mkdir imagemagick && tar -xzf ImageMagick.tar.gz -C imagemagick --strip-components=1
cd imagemagick
./configure \
  --prefix="$INSTALL_DIR" \
  --disable-shared \
  --enable-static \
  --with-heic=yes \
  PKG_CONFIG_PATH="$INSTALL_DIR/lib/pkgconfig" \
  CFLAGS="-I$INSTALL_DIR/include" \
  LDFLAGS="-L$INSTALL_DIR/lib"
make -j4 && make install

# Copy critical binaries to vendor/bin
mkdir -p "$INSTALL_DIR/bin"
cp "$INSTALL_DIR"/ImageMagick-*/bin/convert "$INSTALL_DIR/bin/" 2>/dev/null || true
cp "$INSTALL_DIR"/ImageMagick-*/bin/mogrify "$INSTALL_DIR/bin/" 2>/dev/null || true
cp "$INSTALL_DIR"/ImageMagick-*/bin/identify "$INSTALL_DIR/bin/" 2>/dev/null || true

# Cleanup
echo "[INFO] Cleaning up..."
rm -rf "$TMP_DIR"

# Final message
echo "[SUCCESS] ImageMagick with HEIC support installed to $INSTALL_DIR"