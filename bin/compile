#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2

INSTALL_DIR="$BUILD_DIR/vendor"
mkdir -p "$INSTALL_DIR"

export PATH="$INSTALL_DIR/bin:$PATH"
export LD_LIBRARY_PATH="$INSTALL_DIR/lib:$LD_LIBRARY_PATH"
export PKG_CONFIG_PATH="$INSTALL_DIR/lib/pkgconfig:$PKG_CONFIG_PATH"

# Create temp dir
TMP_DIR=$(mktemp -d)
cd "$TMP_DIR"

# Build and install x265
curl -LO https://bitbucket.org/multicoreware/x265_git/get/master.tar.gz
mkdir x265 && tar -xzf master.tar.gz -C x265 --strip-components=1
cd x265/build/linux
cmake -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR" -DENABLE_SHARED=off ../../source
make -j4 && make install
cd "$TMP_DIR"

# Build and install libde265
curl -LO https://github.com/strukturag/libde265/archive/refs/tags/v1.0.8.tar.gz
mkdir libde265 && tar -xzf v1.0.8.tar.gz -C libde265 --strip-components=1
cd libde265
./autogen.sh
./configure --prefix="$INSTALL_DIR" --disable-shared --enable-static
make -j4 && make install
cd "$TMP_DIR"

# Build and install libheif
curl -LO https://github.com/strukturag/libheif/releases/download/v1.17.6/libheif-1.17.6.tar.gz
mkdir libheif && tar -xzf libheif-1.17.6.tar.gz -C libheif --strip-components=1
cd libheif
./configure --prefix="$INSTALL_DIR" --disable-shared --enable-static
make -j4 && make install
cd "$TMP_DIR"

# Build and install ImageMagick
curl -LO https://imagemagick.org/archive/ImageMagick.tar.gz
mkdir imagemagick && tar -xzf ImageMagick.tar.gz -C imagemagick --strip-components=1
cd imagemagick
./configure --prefix="$INSTALL_DIR" --with-heic --disable-shared --enable-static
make -j4 && make install

# Cleanup
echo "Cleaning up..."
rm -rf "$TMP_DIR"

# Final message
echo "ImageMagick with HEIC support installed to $INSTALL_DIR"
